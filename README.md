# Sovcombank Team Challenge 2022

## Список репозиториев

| Репозиторий                      | Сыылка                                           |
| -------------------------------- | ------------------------------------------------ |
| Клиент                           | https://github.com/vpasport/sovkom-hac           |
| Основной сервер                  | https://github.com/keltdeep/hackathon            |
| Предикт курса                    | https://github.com/kjushka/rate-predicts         |
| Сервис для получения курса валют | https://github.com/kjushka/sovkom-wallet-service |

## Используемые технологии

- Goland
- node js (nestjs)
- react js (nextjs)
- python
- docker
- CI/CD
- PostgreSQL
- Redis

## Реализованные задачи

- [&check;] Ролевая модель (пользователь и администратор приложения, необходимы интерфейсы для каждой роли)
- [&check;] Функционал регистрации новых пользователей (в рамках процесса регистрации создается первый рублевый счет для торговли)
- [&check;] Функционал подтверждения регистрации для администратора приложения
- [&check;] Функционал для блокировки/разблокировки пользователей
- [&check;] Функционал для пополнения и выведения средств с рублевого счета
- [&check;] Функционал открытия нового счета для проведения операций над выбранной пользователем валютой
- [&check;] Отображение сводной информации по имеющимся в портфеле пользователя активам. - Состав представленной информации должен быть обоснован
- [&check;] Отображение исторической информации о движении валюты (отчет по сделанным операциям)
- [&check;] Отображение общей информации о пользователе приложения в удобном и понятном для пользователя виде (профиль текущего пользователя), в т.ч., и информация о реквизитах счетов, с которых совершаются операции над валютами
- [&check;] Функционал торговли, возможность покупать и продавать валюту по рыночному курсу (курс из внешнего источника)
- [&check;] Визуализация графика стоимости валюты/валют за период (график изменения стоимости)
- [&check;] Расчет и визуализация прогнозной стоимости валют(технический анализ, регрессионные модели, ML и т.д.)

## Посмотреть проект можно по ссылкам

- [Ссылка на видео с демонстрацией проекта](https://disk.yandex.ru/i/IrGmHh72r8IYZg)
- [https://stbuddy.xyz/next/login](https://stbuddy.xyz/next/login)

## Параметры входа

| Роль  | Логин | Пароль |
| ----- | ----- | ------ |
| admin | admin | admin  |
| user  | test  | test   |

## Дополнительный функционал

1. Метод запрета торговли определенной валюты, а также ее разблокировка
2. Метод удаления счета, при условии, что на нем нет денежных средств
3. Межвалютные операции, т.е. можно купить евро за доллары
4. Авторизация, при которой формируется jwt-токен
5. Т.к. часто ролевые системы сопровождаются системой прав для каждого пользователя, мы ее также сделали, но нигде не использовали, в основном сервисе бекенда описаны для этого guards, а у юзеров есть соответствующее поле.
6. Метод сброса пароля пользователя.


## Описание сервисов

В корне репозитория есть схемы баз данных

В целом для данного проекта реализована микросервисная архитектура, которая состоит из 4-х частей:
1. frontend с использованием ssr. Это дает возможность выполнять какие-то запросы до отображения страницы пользователю, так же повышает скорость загрузки и в како-то степени безопастности.

В проекте используются различные линтеры и хуки, которые повышают качество кода и архитектуры. Так же при работе нескольких человек над одним проектом уменьшает количество кофликтов из-за разных настроек ide.

Структура проекта стандартны для проектов на реакт:
- компоненты
- утилиты
- хуки
- контексты
- работа с апи
- страницы

Используется свой ui kit, но из-за не совсем говтового его вида также местами используется Primereact.

Для отображения графиков используется chartjs из primereact.

Работа со стилями происходит с помощью sass модулей, что позволяет избежать конфликтов имен классов.

Для работы с формами исользуется Formik.

Работа с временем происходит через moment. 

2. backend на nest js, где происходят все операции по пользователям, авторизации и по счетам. Данный сервис в свою очередь получает данные по валютам из сервиса для работы с валютами написанный на Go. Данный сервис используется как единая точка входа в приложение со стороны серверной части.
Пароли пользователей хранятся в хешированном виде для этого используется bcrypt + salt. Данный сервис внутри поделен на инкапсулированные модули, каждый из который отвечает за свою задачу.

модуль auth - отвечает за регистрацию и авторизацию пользователей, а так же генерирует токен. Тут же происходит описание ролей и прав, описаны их guards
модуль users - отвечает за операции с пользователями, их создание, апдейт. Юзеры в свою очередь имеют дополнительные поля и счета. Это описано отношениями в базе данных.
модуль score - отвечает за операции по счетам, их удаления, пополнения, снятие, транзакции между валютами. Здесь же ведется история всех операций, которая пишется в таблицу transaction_history.
модуль api - модуль для запросов к сторонним апи.

Взаимодействие модулей, если это необходимо, реализуется через внедрение зависимостей.

В качестве софта для манипуляции с базой данных используется typeorm. Посредством миграций осуществляется создание и редактирования таблиц. Выбор typeorm обусловлен тем, что она предоставляется возможность легко перейти на другую базу данных, если это вдруг потребуется.

Также в сервисе реализованы validationPipes - которые валидируют все входящие данные и тем самым делают код чище. Для более удобной отладки приложения подключена зависимость winston - которая реализует запись логов приложения. Также подключен линтер. Сервис разворачивается в Docker-контейнере.

3. Сервис на python - который используется для вычисления графика прогнозирования курса. После проведенного исследования было принято решение использовать библиотеку ARIMA, под капотом которой используется комбинация стандартных алгоритмов машинного обучения. Данная модель предоставляет настройку таких параметров, как например, сезонность, и предназначена именно для прогнозирования значений временных рядов. Также важным преимуществом модели является наличие библиотек, обеспечивающих подбор оптимальных параметров для обучения модели на конкретном временном ряду. Время работы сервиса на данный момент оставляет желать лучшего, однако благодаря внедрению кэша (сервис 4) и возможному увеличению мощностей арендованных серверов. Данный сервер, как и фронтенд разворачиваются с помощью pm2

4. Сервис на Go для работы с сторонним API, который предоставляет доступ к котировкам валюты. Так как данный сервис в основном предоставляет из себя получение данных из других сервисов, был реализован кэш с помощью Redis. Из-за того, что курс валют обновляется раз в день на используемом нами API, у нас была возможность использовать кэш долгое время (1 день), что сильно уменьшает респонс тайм для пользователей. Также данный сервис отвечает за формирование данных для визуализации курсов валют (в том числе прогнозируемых). Данный сервис разворачивается в Docker-контейнере.

Также для автоматизации деплоя данных сервисов был использован ci/cd, который после пуша в репозиторий самостоятельно развертывает все на виртуальной машине.
Важно отметить, что пользователи разделены по ролям, причем администраторы могут быть добавлены непосредственно администратором базы данных. Для работы с удаленной машиной были также настроены ngnix и домен на reg.ru

## Структуры баз данных

- [Основной сервер](https://git.codenrock.com/sovcombankteam/cnrprod-team-26120/SovcombankSolution/-/blob/main/%D1%81%D1%85%D0%B5%D0%BC%D0%B0_%D0%B1%D0%B4_%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D0%BE%D0%B3%D0%BE_%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0.jpg)
- [Сервис работы с курсами валют](https://git.codenrock.com/sovcombankteam/cnrprod-team-26120/SovcombankSolution/-/blob/main/%D1%81%D1%85%D0%B5%D0%BC%D0%B0_%D0%B1%D0%B4_%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0_%D1%81_%D0%BA%D1%83%D1%80%D1%81%D0%B0%D0%BC%D0%B8.jpg)
